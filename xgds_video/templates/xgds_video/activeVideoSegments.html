{% extends "base.html" %}
{% block headExtras %}
{{block.super}}
    <script type="text/javascript" src="{{ STATIC_URL }}external/js/jquery/jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}external/js/jquery/jquery-ui.js"></script>
    
    <script type="text/javascript" src="{{ STATIC_URL }}external/js/masonry.pkgd.min.js" ></script>
    <script type="text/javascript" src="{{ STATIC_URL }}external/js/jwplayer/jwplayer.js"></script>
    <script type="text/javascript">STATIC_URL='{{ STATIC_URL }}'</script>
    <script type="text/javascript" src="{{ STATIC_URL }}xgds_video/js/activeVideoSegments.js"></script>
    <script type="text/javascript">jwplayer.key="Wu88H+wZ8jZd7qICLr7IEKSmml1/EOMXWYcblA/CJVk=";</script>
    <script src="{{STATIC_URL}}external/js/jquery/jquery.tagsinput.js" type="text/javascript" ></script>
 	<script src="{{STATIC_URL}}external/js/jquery/jquery.form.min.js" type="text/javascript" ></script>
 	<script type="text/javascript">var submitNoteUrl = '{% url record_simple %}'</script>
 	<script src="{{STATIC_URL}}xgds_video/js/video_notes_form.js" type="text/javascript" ></script>
{% endblock headExtras %}

 {% block cssExtras %}
 {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}external/css/jquery/jquery.tagsinput.css"></link>
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}external/css/jquery/jquery-ui.css"></link>
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}xgds_video/css/xgds_video.css"></link>
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}external/css/font-awesome/css/font-awesome.css"></link>

{% endblock cssExtras %}

{% block scripts %}
{% endblock %}
    
{% load url from future %}
{% load nav %}
{% block siteSection %}Video{% endblock %}
    {% block nav %}
    {% nav "video.view" %}
    {{ block.super }}
    {% endblock %}
    
    {% block sitemenu-content-secondary %}
	{% include "xgds_video/video_subnav.html" %}
    {% endblock %}
{% block contents %}

    {% if messages %}
        <ul class="messages" id="errorMessage" style="color:red;">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
        </ul>
    {% endif %}

    {% if not episode %}
        <div style="font-size: 1.5em; margin: 20px;">Couldn't find any {{ searchCriteria }}.</div>
    {% else %}
        {% if segmentsJson %}
            <div>
                <div id="sliderGroup">
                    <div id="sliderLabel">
                        Local Flight Time: <input type="text" id="sliderTimeLabel" readonly>
                    </div>
                    
                    <div id="masterSlider"></div>
                    <div> 
                        <a class="btn btn-small btn-info" href="#" onclick=playPauseButtonCallBack()>
                            <i id="playbutton" class="fa fa-pause fa-2x"></i>
                        </a>
                    </div>
                    <div>
                        <input  id="seekTime" type="text" name="text-input" placeholder="&#xf017; play from time (HH:MM:SS)" class="stylish"/>
                        <button type="submit" class="mybutton" id="seekButton" onclick=seekToTime()>
                            <i class="fa fa-share"></i> Seek
                        </button>
                    </div>
                </div>
            </div>

            <div id="container" class="js-masonry" data-masonry-options='{  "itemSelector": ".item", "gutter":5}'>
            {% for source in sources %}
                <div class="item" id="item{{ forloop.counter }}">

                <div id="buttons">
                    <div id=toprow-left>Recorded Segment: {{ source.name }}</div> 
                    <a class="mybutton" id=toprow-right href="{% url 'xgds_video_recorded' %}?source={{ source.shortName }}&episode={{ episode.shortName }}" target="new">New Window</a>
                    {% with feed=source.feed_set.all.0.shortName %}
                    {% if feed %}
                        <a class="mybutton" id=toprow href="{% url 'xgds_video_live' feed %}">Live</a>
                    {% endif %}
                    {% endwith %}
                </div>

                {% include "xgds_video/video_notes.html" with data=source.form %}
                <!--embed the video-->
                <div id="myPlayer{{ source.shortName }}"></div>
                <br>
                <div id="myPlayer{{ source.shortName }}Label" style="text-align:left;font-family:arial,verdana,helvetica"> </div>
                <div>
                    Test Site Time: <span id="testSiteTime{{ source.shortName }}">0</span>
                </div>
                </div>
            {% endfor %}
            </div>

            <script language="javascript" type="text/javascript">
                var baseUrl = "{{ baseUrl }}";
                var STATIC_URL = "{{ STATIC_URL }}";

                //helper for converting json datetime object to javascript date time
                function toJsDateTime(jsonDateTime) {
                    if (jsonDateTime) {
                        return new Date(jsonDateTime.year, jsonDateTime.month, jsonDateTime.day, 
                                        jsonDateTime.hour, jsonDateTime.min, jsonDateTime.seconds, 0);  
                    } else { 
                        return null;
                    }
                }

                //convert episode start/end time to javascript dateTime
                var episode = ({{ episodeJson|safe }}=="None") ? null : {{ episodeJson|safe }};
                if (episode) { 
                    episode.startTime = toJsDateTime(episode.startTime);
                    episode.endTime = toJsDateTime(episode.endTime);
                }
                   
                // displaySegments are in json format like this:
                // displaySegments['RD1'] = {segment1, segment2, segment3}
                // displaySegments['RD1'][0].startTime would return start time of one of the segments.
                var displaySegments = {{ segmentsJson|safe }};

                // convert segment start and end times to javascript dateTime
                var firstSegment = null;
                var lastSegment = null;

                {% for source in sources %}
                    var segments = displaySegments["{{ source.shortName }}"]; 
                    if ((segments != undefined) && (segments.length > 0)) {
                        $.each(segments, function(id) {
                            var segment = segments[id];
                            segment.startTime = toJsDateTime(segment.startTime);
                            segment.endTime = toJsDateTime(segment.endTime);

                            if(firstSegment == null) {
                                firstSegment = segment;
                            }
                            if (lastSegment == null) {
                                lastSegment = segment;
                            }

                            if (segment.startTime) {
                                if(segment.startTime < firstSegment.startTime) {
                                    firstSegment = segment;
                                }
                            }
                            if (segment.endTime) {
                                if (segment.endTime > lastSegment.endTime) {
                                    lastSegment = segment;
                                }
                            }
                        });
                    }
                {% endfor %}

                //set up the slider and the player
                setupSlider();//episode, firstSegment, lastSegment);
                setupJWplayer();//displaySegments, firstSegment, episode);
            </script>
        {% endif %}
    {% endif %}

{% endblock contents %}

{% block jsInit %}
{% include "xgds_video/init_notes.js" %}
{% endblock jsInit %}
